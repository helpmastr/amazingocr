<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmazingSuite | Universal Converter</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="terminal.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/tesseract.js@v5.0.3/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<body class="terminal-body">
    <div class="terminal-container">
        <div class="terminal-window">
            <div class="terminal-header">
                <div class="window-controls">
                    <span class="control close" onclick="window.location.href='hub.html'"></span>
                    <span class="control minimize"></span>
                    <span class="control maximize"></span>
                </div>
                <div class="terminal-title">
                    <i data-lucide="refresh-cw" size="14"></i> af â€” universal-converter â€” v3
                </div>
            </div>

            <div class="terminal-content" style="min-height: 450px;">
                <!-- Step 1: Select Input Type -->
                <div id="step1-view">
                    <div style="margin-bottom: 25px;">
                        <h2 class="terminal-text-green">> SELECT_INPUT_TYPE</h2>
                        <p class="terminal-text-muted">Choose the type of file you want to convert.</p>
                    </div>
                    <div class="hub-grid" style="max-width: 600px; margin: 0 auto;">
                        <div class="hub-card" onclick="selectInputType('doc')">
                            <i data-lucide="file-text" size="28"></i>
                            <h4>Documents</h4>
                            <p>PDF</p>
                        </div>
                        <div class="hub-card" onclick="selectInputType('img')">
                            <i data-lucide="image" size="28"></i>
                            <h4>Images</h4>
                            <p>JPG, PNG, WebP, GIF</p>
                        </div>
                    </div>
                    <p class="terminal-text-muted" style="text-align: center; margin-top: 20px; font-size: 11px;">
                        ðŸ’¡ Video/Audio conversion requires server-side processing
                    </p>
                </div>

                <!-- Step 2: Upload File -->
                <div id="step2-view" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <span class="terminal-text-muted" style="font-size: 12px;">INPUT_TYPE:</span>
                        <span id="selected-type-label" class="terminal-text-green"
                            style="font-size: 12px; margin-left: 8px;">DOCUMENTS</span>
                        <button class="terminal-btn" style="padding: 4px 10px; font-size: 11px; margin-left: 15px;"
                            onclick="goToStep(1)">CHANGE</button>
                    </div>
                    <div id="dropzone" class="terminal-dropzone">
                        <i data-lucide="upload-cloud" size="48" class="terminal-text-blue"></i>
                        <h3 class="terminal-text-green" style="margin: 15px 0 5px;">> UPLOAD_FILE</h3>
                        <p class="terminal-text-muted" style="font-size: 12px;">Drop your file here or click to browse
                        </p>
                    </div>
                    <input type="file" id="file-input" style="display: none;">
                </div>

                <!-- Step 3: Select Output Format & OCR -->
                <div id="step3-view" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <span class="terminal-text-muted" style="font-size: 12px;">FILE:</span>
                        <span id="uploaded-file-label" class="terminal-text-green"
                            style="font-size: 12px; margin-left: 8px;">document.pdf</span>
                        <button class="terminal-btn" style="padding: 4px 10px; font-size: 11px; margin-left: 15px;"
                            onclick="goToStep(2)">CHANGE</button>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 20px; max-width: 400px; margin: 30px auto;">
                        <div>
                            <label class="terminal-text-muted"
                                style="font-size: 12px; display: block; margin-bottom: 8px;">OUTPUT_FORMAT:</label>
                            <select id="output-format" class="terminal-select" style="width: 100%; padding: 12px;">
                                <!-- Dynamically populated -->
                            </select>
                        </div>

                        <div id="ocr-option"
                            style="display: flex; align-items: center; gap: 12px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);">
                            <input type="checkbox" id="ocr-toggle"
                                style="width: 18px; height: 18px; accent-color: var(--terminal-text);">
                            <label for="ocr-toggle" class="terminal-text-muted"
                                style="font-size: 13px; cursor: pointer;">
                                <span class="terminal-text-green">APPLY_OCR</span> â€” Extract text from output
                            </label>
                        </div>

                        <button id="convert-btn" class="terminal-btn primary"
                            style="width: 100%; justify-content: center; padding: 14px;">
                            <i data-lucide="zap" size="16"></i> START_CONVERSION
                        </button>
                    </div>
                </div>

                <!-- Step 4: Processing -->
                <div id="step4-view" style="display: none; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 12px;">
                        <span id="status-label" class="terminal-text-green">PREPARING_BUFFERS...</span>
                        <span id="progress-percent" class="terminal-text-green">0%</span>
                    </div>
                    <div class="progress-container"
                        style="background: rgba(255,255,255,0.05); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div id="progress-bar"
                            style="height: 100%; width: 0%; background: var(--terminal-text); box-shadow: 0 0 10px var(--terminal-text); transition: width 0.1s;">
                        </div>
                    </div>
                    <div id="processing-log" class="terminal-text-muted"
                        style="font-size: 11px; margin-top: 25px; height: 120px; overflow-y: auto; line-height: 1.6; border-left: 1px solid rgba(0,255,65,0.2); padding-left: 15px;">
                    </div>
                </div>

                <!-- Step 5: Results -->
                <div id="step5-view" style="display: none; text-align: center; padding: 40px 20px;">
                    <div class="terminal-text-green" style="margin-bottom: 25px; font-size: 18px; font-weight: 700;">
                        <i data-lucide="check-circle" size="24" style="vertical-align: middle; margin-right: 10px;"></i>
                        <span id="finish-message">CONVERSION_COMPLETE</span>
                    </div>
                    <div id="ocr-results" style="display: none; text-align: left; margin-bottom: 25px;">
                        <label class="terminal-text-muted" style="font-size: 11px;">EXTRACTED_TEXT:</label>
                        <textarea id="ocr-text" readonly class="terminal-input"
                            style="width: 100%; min-height: 150px; margin-top: 8px; resize: none; font-size: 12px;"></textarea>
                    </div>
                    <div class="terminal-button-group" style="justify-content: center;">
                        <button id="download-btn" class="terminal-btn primary">
                            <i data-lucide="download" size="14"></i> DOWNLOAD_RESULT
                        </button>
                        <button id="reset-btn" class="terminal-btn" onclick="location.reload()">
                            <i data-lucide="refresh-cw" size="14"></i> NEW_TASK
                        </button>
                    </div>
                </div>

                <div class="terminal-prompt-footer" style="margin-top: 20px; font-size: 12px; opacity: 0.5;">
                    <span class="terminal-text-blue">af@amazing-suite</span> <span class="terminal-text-muted">:~
                        $</span> <span class="cursor"
                        style="display: inline-block; width: 8px; height: 15px; background: #fff; vertical-align: middle;"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- macOS Dock -->
    <div class="terminal-dock">
        <div class="dock-item" data-label="Home" onclick="window.location.href='index.html'">
            <i data-lucide="home"></i>
        </div>
        <div class="dock-item" data-label="Converter Hub" onclick="window.location.href='hub.html'">
            <i data-lucide="layout-grid"></i>
        </div>
        <div class="dock-item" data-label="OCR Engine" onclick="window.location.href='engine.html'">
            <i data-lucide="scan-text"></i>
        </div>
        <div class="dock-item" data-label="GitHub"
            onclick="window.open('https://github.com/helpmastr/amazingocr', '_blank')">
            <i data-lucide="github"></i>
        </div>
    </div>

    <script>
        // Configure pdf.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const INPUT_ACCEPT = {
            'doc': '.pdf',
            'img': '.jpg,.jpeg,.png,.webp,.gif,.bmp'
        };

        const INPUT_LABELS = {
            'doc': 'DOCUMENTS (PDF)',
            'img': 'IMAGES'
        };

        const OUTPUT_FORMATS = {
            'doc': [
                { value: 'png', label: 'PNG (Image)' },
                { value: 'jpg', label: 'JPG (Image)' }
            ],
            'img': [
                { value: 'pdf', label: 'PDF (Document)' },
                { value: 'png', label: 'PNG' },
                { value: 'jpg', label: 'JPG' },
                { value: 'webp', label: 'WebP' }
            ]
        };

        let currentInputType = null;
        let uploadedFile = null;
        let convertedBlob = null;
        let convertedFileName = '';

        function selectInputType(type) {
            currentInputType = type;
            document.getElementById('selected-type-label').textContent = INPUT_LABELS[type];
            document.getElementById('file-input').accept = INPUT_ACCEPT[type];
            goToStep(2);
        }

        function goToStep(step) {
            document.getElementById('step1-view').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('step2-view').style.display = step === 2 ? 'block' : 'none';
            document.getElementById('step3-view').style.display = step === 3 ? 'block' : 'none';
            document.getElementById('step4-view').style.display = step === 4 ? 'block' : 'none';
            document.getElementById('step5-view').style.display = step === 5 ? 'block' : 'none';
            lucide.createIcons();
        }

        // File upload handlers
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');

        dropzone.addEventListener('click', () => fileInput.click());
        dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('drag-over'); });
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) handleFileUpload(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFileUpload(e.target.files[0]);
        });

        function handleFileUpload(file) {
            uploadedFile = file;
            document.getElementById('uploaded-file-label').textContent = file.name;
            populateOutputFormats();
            goToStep(3);
        }

        function populateOutputFormats() {
            const select = document.getElementById('output-format');
            select.innerHTML = '';
            const formats = OUTPUT_FORMATS[currentInputType] || [];
            formats.forEach(fmt => {
                const opt = document.createElement('option');
                opt.value = fmt.value;
                opt.textContent = fmt.label;
                select.appendChild(opt);
            });

            // Show OCR option only for image outputs
            const ocrOption = document.getElementById('ocr-option');
            ocrOption.style.display = currentInputType === 'doc' ? 'flex' : 'none';
        }

        // Progress helpers
        function updateProgress(percent, label) {
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-percent').textContent = `${Math.round(percent)}%`;
            document.getElementById('status-label').textContent = label;
        }

        function addLog(text) {
            const log = document.getElementById('processing-log');
            log.innerHTML += `<div>> ${text}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // Convert button
        document.getElementById('convert-btn').addEventListener('click', startConversion);

        async function startConversion() {
            const outputFormat = document.getElementById('output-format').value;
            const applyOCR = document.getElementById('ocr-toggle').checked;

            goToStep(4);
            document.getElementById('processing-log').innerHTML = '';

            try {
                addLog('MOUNTING_FILESYSTEM...');
                updateProgress(5, 'MOUNTING_FILESYSTEM...');
                await sleep(200);

                addLog(`INPUT_FILE: ${uploadedFile.name}`);
                addLog(`OUTPUT_FORMAT: ${outputFormat.toUpperCase()}`);
                updateProgress(10, 'ANALYZING_INPUT...');
                await sleep(200);

                let result;

                if (currentInputType === 'img') {
                    // Image conversions
                    if (outputFormat === 'pdf') {
                        result = await convertImageToPDF(uploadedFile);
                    } else {
                        result = await convertImageFormat(uploadedFile, outputFormat);
                    }
                } else if (currentInputType === 'doc') {
                    // PDF to Image
                    result = await convertPDFToImages(uploadedFile, outputFormat, applyOCR);
                }

                convertedBlob = result.blob;
                convertedFileName = result.filename;

                updateProgress(100, 'CONVERSION_COMPLETE');
                addLog('CONVERSION_COMPLETE');
                await sleep(300);

                goToStep(5);
                document.getElementById('finish-message').textContent = `CONVERTED_TO_${outputFormat.toUpperCase()}_SUCCESS`;

                if (result.ocrText) {
                    document.getElementById('ocr-results').style.display = 'block';
                    document.getElementById('ocr-text').value = result.ocrText;
                }

                lucide.createIcons();

            } catch (err) {
                addLog(`ERROR: ${err.message}`);
                updateProgress(0, 'CONVERSION_FAILED');
                alert('Conversion failed: ' + err.message);
            }
        }

        // ==================== ACTUAL CONVERSION FUNCTIONS ====================

        async function convertImageFormat(file, targetFormat) {
            addLog('LOADING_IMAGE...');
            updateProgress(20, 'LOADING_IMAGE...');

            const img = await loadImage(file);

            addLog('CREATING_CANVAS...');
            updateProgress(40, 'CREATING_CANVAS...');

            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');

            // White background for JPG (no transparency)
            if (targetFormat === 'jpg' || targetFormat === 'jpeg') {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            ctx.drawImage(img, 0, 0);

            addLog('ENCODING_OUTPUT...');
            updateProgress(70, 'ENCODING_OUTPUT...');

            const mimeType = targetFormat === 'jpg' ? 'image/jpeg' :
                targetFormat === 'webp' ? 'image/webp' : 'image/png';

            const blob = await new Promise(resolve => canvas.toBlob(resolve, mimeType, 0.92));

            const baseName = file.name.replace(/\.[^.]+$/, '');
            const filename = `${baseName}_converted.${targetFormat}`;

            updateProgress(90, 'FINALIZING...');
            addLog('OUTPUT_READY');

            return { blob, filename };
        }

        async function convertImageToPDF(file) {
            addLog('LOADING_IMAGE...');
            updateProgress(20, 'LOADING_IMAGE...');

            const img = await loadImage(file);
            const arrayBuffer = await file.arrayBuffer();

            addLog('CREATING_PDF_DOCUMENT...');
            updateProgress(40, 'CREATING_PDF_DOCUMENT...');

            const pdfDoc = await PDFLib.PDFDocument.create();

            let embeddedImage;
            const fileType = file.type;

            if (fileType === 'image/png') {
                embeddedImage = await pdfDoc.embedPng(arrayBuffer);
            } else {
                // Convert to JPG for other formats
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);

                const jpgBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92));
                const jpgBuffer = await jpgBlob.arrayBuffer();
                embeddedImage = await pdfDoc.embedJpg(jpgBuffer);
            }

            addLog('ADDING_PAGE...');
            updateProgress(60, 'ADDING_PAGE...');

            const page = pdfDoc.addPage([embeddedImage.width, embeddedImage.height]);
            page.drawImage(embeddedImage, {
                x: 0,
                y: 0,
                width: embeddedImage.width,
                height: embeddedImage.height
            });

            addLog('SAVING_PDF...');
            updateProgress(80, 'SAVING_PDF...');

            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });

            const baseName = file.name.replace(/\.[^.]+$/, '');
            const filename = `${baseName}.pdf`;

            addLog('OUTPUT_READY');

            return { blob, filename };
        }

        async function convertPDFToImages(file, outputFormat, applyOCR) {
            addLog('LOADING_PDF...');
            updateProgress(10, 'LOADING_PDF...');

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const totalPages = pdf.numPages;

            addLog(`DETECTED_PAGES: ${totalPages}`);

            const images = [];
            let ocrText = '';

            for (let i = 1; i <= totalPages; i++) {
                const progress = 10 + (70 * (i / totalPages));
                addLog(`RENDERING_PAGE_${i}...`);
                updateProgress(progress, `RENDERING_PAGE_${i}/${totalPages}...`);

                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 }); // Good quality

                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                const ctx = canvas.getContext('2d');

                await page.render({ canvasContext: ctx, viewport }).promise;

                const mimeType = outputFormat === 'jpg' ? 'image/jpeg' : 'image/png';
                const blob = await new Promise(resolve => canvas.toBlob(resolve, mimeType, 0.92));
                images.push({ blob, pageNum: i });

                // Run OCR if requested
                if (applyOCR) {
                    addLog(`OCR_SCANNING_PAGE_${i}...`);
                    try {
                        const result = await Tesseract.recognize(canvas, 'eng');
                        ocrText += `--- Page ${i} ---\n${result.data.text}\n\n`;
                    } catch (e) {
                        ocrText += `--- Page ${i} ---\n[OCR Error: ${e.message}]\n\n`;
                    }
                }
            }

            addLog('PACKAGING_OUTPUT...');
            updateProgress(85, 'PACKAGING_OUTPUT...');

            let resultBlob, resultFilename;

            if (images.length === 1) {
                resultBlob = images[0].blob;
                const baseName = file.name.replace(/\.[^.]+$/, '');
                resultFilename = `${baseName}_page1.${outputFormat}`;
            } else {
                // Multiple pages - create ZIP
                addLog('CREATING_ZIP_ARCHIVE...');
                const zip = new JSZip();
                const baseName = file.name.replace(/\.[^.]+$/, '');

                for (const img of images) {
                    zip.file(`${baseName}_page${img.pageNum}.${outputFormat}`, img.blob);
                }

                if (ocrText) {
                    zip.file(`${baseName}_ocr.txt`, ocrText);
                }

                resultBlob = await zip.generateAsync({ type: 'blob' });
                resultFilename = `${baseName}_pages.zip`;
            }

            addLog('OUTPUT_READY');

            return { blob: resultBlob, filename: resultFilename, ocrText: applyOCR ? ocrText : null };
        }

        // Helpers
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Download handler
        document.getElementById('download-btn').addEventListener('click', () => {
            if (!convertedBlob) {
                alert('No converted file available');
                return;
            }

            const url = URL.createObjectURL(convertedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = convertedFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Initialize
        lucide.createIcons();
    </script>
</body>

</html>